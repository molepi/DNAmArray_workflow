
```{r, child="_setup.Rmd"}
```

***

# Importing IDATs #

The first step of any analysis of microarray data involves importing the raw intensity files into your software program. In this example, we show how to import raw IDAT files from GEO into R, but similar strategies can be employed for all Illumina methylation array files when using R. 

Using [**GEOquery**](http://bioconductor.org/packages/release/bioc/html/GEOquery.html) [@Davis2007], you can download the [example data](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE113018) [@Cobben2019]. This package contains functions that bridge the gap between between [BioConductor](https://www.bioconductor.org) tools and [GEO](https://www.ncbi.nlm.nih.gov/geo/), which is a public repository of microarray data.

Initially, we use `getGEOSuppFiles()` to download the supplementary data to the current working directory. These consist of an archive containing the raw IDATs alongside some documentation. We extract these and store them in our chosen directory, ready for decompression.

```{r 201geoquery, eval=FALSE}
library(GEOquery)
getGEOSuppFiles("GSE113018")
untar(tarfile="./GSE113018/GSE113018_RAW.tar", exdir="./GSE113018/IDATs")
```

After creating a list of files, we utilise the `gunzip()` function to efficiently unpack the data.

```{r 202idats, eval=FALSE}
setwd("./GSE113018/IDATs")
sapply(list.files(), gunzip)
```

We then use `getGEO()` to import SOFT format microarray data into R as a large GSE-class list. This contains a multitude of information, but we extract the phenotypic and meta-data of interest. 

```{r 203getgeo, eval=FALSE}
GSE113018 <- getGEO(GEO="GSE113018")
targets <- pData(phenoData(GSE113018[[1]]))
```

***

# Using MethylAid #

We now have the data we need to commence quality control, but some reformatting is needed. The [**MethylAid**](http://bioconductor.org/packages/MethylAid)
[@Luijk2014] package that we developed requires the targets data frame to store IDAT file root names in a `Basename` column. Sometimes, data comes with a sample sheet to faciliate this, but in this case the information needs to be extracted from the supplementary file column instead. 

```{r 205basename, eval=FALSE}
targets$Basename <- substring(targets$supplementary_file,68,95)
```

The following sample quality control steps require the [**MethylAid**](http://bioconductor.org/packages/MethylAid) and [**BiocParallel**](https://bioconductor.org/packages/release/bioc/html/BiocParallel.html) packages. Using parallel processing and/or batches will reduce both memory load and run-times when extracting intensities from IDAT files. Please see the [MethylAid vignette](http://bioconductor.org/packages/release/bioc/vignettes/MethylAid/inst/doc/MethylAid.pdf) for more details.

```{r 206sdata, eval=FALSE}
library(MethylAid)
library(BiocParallel)
BPPARAM <- MulticoreParam(10)
sData <- summarize(targets, batchSize=50, BPPARAM=BPPARAM)
```

After this `summarize()`, the Shiny web application can be launched to `visualize()` the data and identify outliers. In this instance, there are no apparent outliers, but if found they can be removed from the dataset. To easier visualise if your data conforms to typical patterns, you can utilise the [**MethylAidData**](http://bioconductor.org/packages/release/data/experiment/html/MethylAidData.html) package alongside the `background` option. Darker blue colours indicate regions where many observations are found in the example data, and can serve as a guide for expected peak areas. 

```{r 207methylaid, eval=FALSE}
library(MethylAidData)
data(exampleDataLarge)
outliers <- visualize(sData, background=exampleDataLarge)
targets <- targets[!(rownames(targets) %in% rownames(outliers)), ]
```

***

# Preparing `targets` #

Before progressing further, it can help to take some time to get familiar with the `targets` data frame, removing duplicate information and converting variables to relevant classes. 

```{r 204load, echo=FALSE}
load("C:/Users/ljsinke/Documents/git/GitHub/test_workflow/data/targets_mod.RData")
```

``` {r 205structure}
head(targets[c(28,30,32,34)])
```

This data frame consists of 138 observations, with 46 fetal alcohol spectrum disorder (FASD) cases and 92 controls, and phenotypic information for 36 variables is stored after cleaning. This includes values that quantify the severity of FASD in cases, such as `facial`, `growth`, and `cns`, as well as covariates we want to adjust for in the analysis, like `age` and `sex`.

***

# Creating an `RGset` #

For the rest of the pipeline, our data will need to be available as an `RGChannelSetExtended` object. Reading in large numbers of IDAT files is memory-intensive and time-consuming. Therefore, our [**DNAmArray**](https://github.com/molepi/DNAmArray) package offers the `read.metharray.exp.par()` function, which distributes the IDAT files to each of the workers registered using [**BiocParallel**](https://bioconductor.org/packages/release/bioc/html/BiocParallel.html). It then passes them in batches to `read.metharray.exp()` from [**minfi**](http://bioconductor.org/packages/minfi) [@Feinberg2014] and combines the returned `RGset` objects.

```{r 208rgsetshow, eval=FALSE}
library(DNAmArray)
register(MulticoreParam(6))
RGset <- read.metharray.exp.par(targets, verbose=TRUE, extended=TRUE)
```

```{r 209rgsethide, echo=FALSE}
library(DNAmArray)
RGset <- read.metharray.exp(base="C:/Users/ljsinke/Documents/r/cd/GSE113018/IDATs", targets, extended=TRUE)
```

Reading data in parallel is subject to errors and debugging is often difficult. Recently, [**BiocParallel**](https://bioconductor.org/packages/release/bioc/html/BiocParallel.html) has been extended with a comprehensive set of functions for debugging on various parallel architectures. If problems arise, we recommend using `BatchJobsParam()` with the `log=TRUE` option in order to facilitate resolution.

Our data is now an `RGset` object that can used for visualization. You can see below that inside this object the `colData` holds the same information as `targets`, and that there are 5 `assay` layers. The annotation information tells us that the methylation was measured using a 450k array and that hg19 is the reference genome. 

```{r 210rgset}
RGset
```

***

# References #
