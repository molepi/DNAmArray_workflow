
```{r, child="_setup.Rmd"}
```

# Running MethylAid #
	
Sample quality control is performed using the
[**MethylAid**](http://bioconductor.org/MethylAid)
[@Iterson2014]. [**MethylAid**](http://bioconductor.org/MethylAid) is
specially designed for quality control of large sets of DNA
methylation data e.g., epigenomewide association studies
(EWAS). Extracting intensities from IDAT files can be done in batches
and/or in parallel to reduce memory load and/or overcome long
run-times. It requires two function calls in going from IDAT files to
launch the interactive web application; `summarize` and
`visualize`. For more information see [@Iterson2014].

First, prepare the targets file, similar to the one used by 
[**minfi**](http://bioconductor.org/minfi).

```{r sqc.generatetargets, message=FALSE, results='hide'}
path450k <- "/virdir/Backup/RP3_data/IlluminaHumanMethylation450k/450k/LLS"
targets <- read.table(file.path(path450k, "sample_sheet.txt"), sep=",", header=TRUE, as.is=TRUE)
head(targets)
targets$Basename <- with(targets,
                              file.path(path450k, Sentrix_Barcode,
                                        paste(Sentrix_Barcode, Sentrix_Position, sep="_")))
```

```{r sqc.targets, dependson="sqc.generatetargets"}
targets[1:5, 1:5]
```

Next, summarize and visualize the data, see the
[MethylAid vignette](https://www.bioconductor.org/packages/release/bioc/vignettes/MethylAid/inst/doc/MethylAid.pdf)
for more details.

```{r sqc.methylaid, dependson="sqc.generatetargets", eval=FALSE}
library(MethylAid)
library(BiocParallel)
library(BatchJobs)
conffile <- system.file("scripts/config.R", package="MethylAid")
BPPARAM <- BatchJobsParam(workers = 10, progressbar = FALSE, conffile = conffile)
sData <- summarize(targets, batchSize = 50, BPPARAM = BPPARAM)
```

```{r, eval=FALSE}
load(file.path(path450k, "MethylAid.RData"))
outliers <- visualize(MethylAid)
write.table(outliers,
            file=file.path(path450k, "outliers.txt"),
            quote=FALSE, row.names=FALSE)
```

Check the interactive visualization of the
[LLS 450k data](http://bios-vm.bbmrirp3-lumc.surf-hosted.nl:8008/BIOSRutils/DNAm/LLS)
generated by [**MethylAid**](http://bioconductor.org/MethylAid).

It turns out that 5 samples do not pass quality control.

# Constructing an `RGset`-object in parallel #

Reading a large number of IDAT-files can be time-consuming. The
[**DNAmArray**](https://github.com/molepi/DNAmArray) package offers
the `read.metharray.exp.par`-function for reading IDAT-files in parallel
using functionallity from
[**BiocParallel**](http://bioconductor.org/BiocParallel). The
target-file is divided in a number of smaller targets files according
to the number of workers (compute nodes) available. On each worknode a
subset of IDAT-files are read using the regular
[**minfi**](http://bioconductor.org/minfi)
function-`read.metharray.expr`. Once all idat-files are read they are
combined into on `RGChannelSet`-object and returned.

First, we remove those samples that did not pass quality control.

```{r ri.removeoutliers, dependson="sqc.generatetargets"}
outliers <- read.table(file.path(path450k, "outliers.txt"), header=TRUE)    
targets <- targets[!(targets$run_id %in% outliers$run_id), ]
```

For example, running on a cluster with the Sun Grid Job scheduler.
	
```{r ri.readidats, results='hide', messages=FALSE, dependson="ri.removeoutliers"}
library(DNAmArray)
library(BiocParallel)
library(BatchJobs)
register(MulticoreParam(6))
RGset <- read.metharray.exp.par(targets, verbose=TRUE, extended=TRUE)
```

```{r ri.rgset, dependson="ri.readidats"}
RGset
```

Reading data in parallel can go wrong and often debugging is
difficult. Recently,
[**BiocParallel**](http://bioconductor.org/BiocParallel) has been
extended with a comprehensive set of functions for debugging on
various parallel architectures. We recommend running
e.g. `BatchJobsParam` with option `log=TRUE`.

# References #
