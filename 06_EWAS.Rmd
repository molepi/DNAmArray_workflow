
```{r, child="_setup.Rmd"}
```

```{r 701start, echo=FALSE, message=FALSE, results='hide'}
load("C:/Users/ljsinke/Documents/git/GitHub/test_workflow/data/targets_mod.RData")
RGset <- read.metharray.exp(base="C:/Users/ljsinke/Documents/r/cd/GSE113018/IDATs", targets, extended=TRUE)
GRset <- preprocessFunnorm.DNAmArray(RGset, nPCs=4, keepCN=FALSE)
RGset <- probeFiltering(RGset)
betas <- reduce(GRset, RGset, what="beta")
betas <- probeMasking(betas, array="450", genome="hg19")

rowRanges <- getPlatform(platform="HM450", genome="hg19")
rows <- match(rownames(betas), names(rowRanges))
rowRanges <- rowRanges[rows]

cols <- match(colnames(betas), colnames(RGset))
colData <- DataFrame(colData(RGset[, cols])@listData)

methData <- SummarizedExperiment(assays=SimpleList(betas=betas),
                                 rowRanges=rowRanges,
                                 colData=colData)
```


***

# Probe Annotation #

Our package also contains a `cpgInfo()` function, which can be used to map CpG probes to their nearest genes. This utilises the [**TxDb.Hsapiens.UCSC.hg19.knownGene**](http://bioconductor.statistik.tu-dortmund.de/packages/3.6/data/annotation/html/TxDb.Hsapiens.UCSC.hg19.knownGene.html) package, which accesses the USCS annotation databases.

```{r 615annotate}
cpgs <- rownames(betas)
cpgInfo <- cpgInfo(cpgs, TxDb="TxDb.Hsapiens.UCSC.hg19.knownGene")
cpgInfo[1:10, 1:7]
```

***

# Simple EWAS using **limma** #

Our approach for running an EWAS is similar to the approach of [**missMethyl**](http://bioconductor.org/packages/missMethyl/), except that we skip the empirical Bayes step, because the sample size in an EWAS is large enough and there is no added value in including this.

We assume the data has been normalized, filtered and NA's have been imputed. Furthermore, it is very convenient to construct a `SummarizedExperiment` class object as described in the previous section. In our data we have cases and controls, and our primary interest is differential methylation between the two. We want to adjust for likely confounders, such as age and sex.

```{r 702casen}
table(methData$case_control)
```

It is important to ensure that all variables are of a type that facilitates model fitting, so age is converted to a continuous variables and all others are treated as factors. The model formula that you would like to run can be added into your data as shown, ensuring that the covariate of interest immediately follows the tilde. 

```{r 703formula}
ourData <- methData[, methData$case_control %in% c("FASD", "control")]

metadata(ourData)$formula <- ~case_control + age + sex
```

By subsetting our `SummarizedExperiment` object, we can extract covariates with complete information. Sex chromosome probes are also filtered out here.

```{r 704complete}
covariates <- get_all_vars(metadata(ourData)$formula, data=colData(ourData))
nas <- apply(covariates, 1, anyNA)
ourData <- ourData[, !nas]

ourData <- ourData[!(seqnames(ourData) %in% c("chrX", "chrY")),]
```

The `design` object is a matrix holding coefficient multipliers for each observation. As you can see, it is very important to check this to be sure that variables are being handled correctly.

```{r 705model}
design <- model.matrix(metadata(ourData)$formula, data=colData(ourData))
design[1:10,1:3]
```

After extracting beta values from our data, we can use the `lmFit()` function from [**limma**](https://bioconductor.org/packages/release/bioc/html/limma.html) to fit the model. Returned p-values are adjusted for multiple testing using the Bonferroni correction, and the CpG sites bearing most significance are returned for inspection.

```{r 706ewas}
data <- assays(ourData)$assays

library(limma)
fit <- lmFit(data, design)

tstat <- fit$coef/fit$stdev.unscaled/fit$sigma

pval <- 2*pnorm(-abs(tstat[,2]))
padj <- p.adjust(sort(pval, decreasing=FALSE), method="bonf")
head(padj[padj < 0.05])
```

# Correct for bias and inflation #

We developed a package called [**bacon**](http://bioconductor.org/packages/bacon) to estimate and correct for bias and inflation for EWAS (and TWAS)[@VanIterson2017] it maximizes power while properly controlling the false positive rate. [**bacon**](http://bioconductor.org/packages/bacon) is based on the estimation of the empirical null distribution using Bayesian statistics. 

The utility of the tool was illustrated through the application of meta-analysis by performing epigenome- and
transcriptome-wide association studies (EWASs/TWASs) on age and smoking which highlighted an overlap in differential methylation and expression of associated genes. It can be used to remove inflation and
bias often observed in EWAS/TWAS see for more details[@VanIterson2017].

For example, we can use it on the EWAS that we have just run.

```{r bacon, eval=FALSE}
library(bacon)
library(BiocParallel)
register(MulticoreParam(2))
```

```{r}
library(bacon)
bc <- bacon(tstat[,2])
bc
```

# References #
