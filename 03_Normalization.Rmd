
```{r, child="_setup.Rmd"}
```

***

# Principal Components Selection #

Since the default of selecting only two principal components is often too restrictive for this type of data, our `screeplot()` function allows visualisation of eigenvalues to help select the optimal number. Often you will see a drop-off in proportion of variance explained after a certain number of principal components, and this can indicate an efficient cut-off. 

```{r 401start, echo=FALSE, message=FALSE}
load("C:/Users/ljsinke/Documents/git/GitHub/test_workflow/data/targets_mod.RData")
RGset <- read.metharray.exp(base="C:/Users/ljsinke/Documents/r/cd/GSE113018/IDATs", targets, extended=TRUE)
```

```{r 402screeplot}
par(mar=c(5,5,4,2), mgp=c(2.5,1,0), cex.main=1.5, font.main="1", fg="#6b6b6b", col.main="#4b4b4b")
pc <- screeplot(RGset)
``` 

This plot shows that only a small amount of variance is explained after the fourth principal component. For this reason, we choose to carry out normalization using 4 principal components.

***

# Functional normalization #

Our workflow uses the Functional Normalization approach [@Hansen2014], since this includes both NOOB background correction and a dye bias correction step [@Triche2013]. This method uses internal control probes, which are independent and not designed to measure biological differences. 

Although there has been some suggestion that using the internal bisulfite controls is biased [@Zhou2017], this was mostly due to large amounts of non-CpG methylation, which in the vast majority of samples is rare [@He2015]. Functional Normalization has been shown to outperform most, if not all, current normalization methods [@Fortin2017].

By default, functional normalization returns normalized copy number data making the returned `GenomicRatioSet` twice the size necessary when only beta-values or M-values are required. Therefore, we developed `preprocessFunnorm.DNAmArray()`, which adds an option not to return these to the `preprocessFunnorm()` function from [**minfi**](https://bioconductor.org/packages/release/bioc/html/minfi.html) [@Feinberg2014].

```{r 403funnorm}
GRset <- preprocessFunnorm.DNAmArray(RGset, nPCs=4, keepCN=FALSE)
GRset
```

This function returns beta-values calculated with an offset of 100, similar to specifying `getBeta()` with option `type='Illumina'`. If required, these can be transformed to M-values using [**minfi**](https://bioconductor.org/packages/release/bioc/html/minfi.html)'s `getM()` which applies a logit2-transformation to the beta-values.

From inspecting the `GenomicRatioSet` object, you can see that there is one `Beta` assay, with methylation values for 485,512 CpG sites. 

***

# References #


