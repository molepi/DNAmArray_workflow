
***

# Phenotype Prediction #

It can be useful to predict phenotypes in your data, either for comparison to assumed categories or to help impute missing values. Whole blood sample cell-type composition and sex predictors are already included in this package, and we are in the process of creating predictors for age and smoking status. Meanwhile, below are some current methods to predict these phenotypes in your data. 

It is important to carry out predictions prior to probe masking, as many probes masked for analysis (e.g. those on sex chromosomes) are still useful for predicting phenotypes. Additionally, we advise imputing missing vaues before phenotype prediction, since many predictors use only a subset of available probes and missing data can seriously impact accuracy. 

EPICv2 CpGs have cpg_tech names, which may not work for predictors. There are also up to 10 reps for specific CPGs. Choose one, maybe with best detP or maybe at random. 

At some point save complete for predict. 

***

# Predict Cell Counts #

Using [BIOS consortium](https://www.bbmri.nl/samples-images-data) data, which contains multiomics measures from 6 Dutch biobanks comprising ~4000 individuals, we trained a predictor for cell-type composition of whole blood samples. This was based on methylation values from 481,388 CpGs for 2,852 individuals and code for building the predictor can be found at the bottom of this page, should you wish to replicate the process in your own large dataset.

Epidish: also include other predictors in EPIdish including Manhoor's and cord blood, unify?

```{r}
library(EpiDISH)
data(cent12CT.m)

BloodFrac.m <- epidish(beta.m = betas, ref.m = cent12CT.m, method = "RPC")$estF

BloodFrac.m_long <- pivot_longer(as.data.frame(BloodFrac.m), cols = colnames(BloodFrac.m))

BloodFrac.m_long %>% 
  ggplot(aes(y=name, x=value)) +
  geom_boxplot() +
  theme_bw() + ylab('')
```

***

# Predict Sex #

The [**DNAmArray**](https://github.com/molepi/DNAmArray) package contains a `getSex.DNAmArray()` function, which predicts the sex of your observations by inspecting intensities of X-chromosome signals. 
Need betas still with sex chromosomes in :)

Maybe sex prediction is more sample QC? check Thomas update matches ours

```{r eval=F}
anno <- read_tsv("./data/EPIC.hg19.manifest.tsv.gz")

anno <- anno %>% 
  dplyr::select(
    cpg = probeID,
    chr = CpG_chrm,
    start = CpG_beg,
    end = CpG_end,
    strand = probe_strand,
    gene_HGNC,
    MASK_general,
    probeType
  ) %>% 
  mutate(
    chr = substr(chr,4,5)
  )

str(anno)

chrX <- (anno %>% filter(chr == "X" & probeType == "cg"))$cpg

head(rownames(betas))

head(chrX)

table(rownames(betas) %in% chrX)

betaX <- betas[rownames(betas) %in% chrX, ]

nopoX <- colSums(betaX >= 0.2 & betaX <= 0.6, na.rm=T)
nopoX <- ifelse(nopoX <= 20000, "Male", "Female")
table(nopoX)

table(targets$sex)
```

As you can see, this is complete data, but the predicted and assumed sexes are identical. This means that we can feel increased confidence that no incorrect labelling or mix-ups are present.

***

No smoking predictor

No epiage

