
```{r, child="_setup.Rmd"}
```

***

# Filtering on Intensities #

We recommend performing probe-filtering by setting unreliably measured probes to NA. Unfortunately, Functional Normalization does not allow NA's in the `RGChannelSet`. Therefore, it is best to run normalization and probe-filtering separately and combine the results afterwards using our `reduce()` function. 

Some observations need to be removed from the dataset since they provide little to no information that could skew analyses. Probes which have zero intensity or are based on very few (default: <3) beads are removed, based on a specified cut off. 

```{r 501start, echo=FALSE, message=FALSE, results='hide'}
load("C:/Users/ljsinke/Documents/git/GitHub/test_workflow/data/targets_mod.RData")
RGset <- read.metharray.exp(base="C:/Users/ljsinke/Documents/r/cd/GSE113018/IDATs", targets, extended=TRUE)
GRset <- preprocessFunnorm.DNAmArray(RGset, nPCs=4, keepCN=FALSE)
```

```{r 502filter}
RGset <- probeFiltering(RGset)
```

There are differences between probe types that are used in `probeFiltering()`. Information on these can be extracted and stored using functions from [**minfi**](https://bioconductor.org/packages/release/bioc/html/minfi.html) [@Feinberg2014].

```{r 503probeinfo}
locusNames <- getManifestInfo(RGset, "locusNames")
typeII <- getProbeInfo(RGset, type="II")
typeI <- getProbeInfo(RGset, type="I")
```

***

# Detection p-values #

The negative controls on the array can be used to detect outlying samples via the detection p-values, which measure how likely it is a sample's signal differs from the background. Signals that do not differ substantially (default: p<0.01) are removed. We utilise `detectionP()` from [**minfi**](https://bioconductor.org/packages/release/bioc/html/minfi.html) inside our function to achieve this. 
Additionally, samples where a large proportion (default: >5%) of probes were set to NA based on the above probe-level filtering are removed. 

Our function `reduce()` takes the normalized `GRset` from the previous section and the filtered `RGset` created above and returns filtered beta or M-values, which can be passed to the `probeMasking()` function. If M-values are specified as the output, these are scaled to have a range of 32 instead of to infinite values.

```{r 504reduce}
betas <- reduce(GRset, RGset, what="beta")
```

***

# Ambiguous probes #

Several studies [@Chen2013, @Zhou2017] have characterized cross-reactive and polymorphic probes on both the 450k and EPIC methylation arrays and made suggestions for removal. We chose to remove probes identified by Zhou et al., since this set is actively maintained and supports both array sizes. Additionally, different sets are specified depending on the reference genome used.

In total, Zhou et al. suggest removal of probes for a variety of reasons, from ambiguous mapping and cross-reactivity to polymorphisms that interfere with extension. In general, around 60.000 probes are suggested for removal in 450k arrays, and 100.000 for EPIC. 

We developed the `probeMasking()` function, which removes specified probes from either beta- or M- value matrices. In this instance, 59.780 CpG rows are removed. 

```{r 505zhoumask}
betas <- probeMasking(betas, array="450", genome="hg19")
```

Looking at all types of probe filtering, 61,926 sites were removed, reducing the total number to 423,586. The vast majority of these were cross-reactive or polymorphic CpGs. 

***

# References #
