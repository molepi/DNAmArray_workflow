
```{r, child="_setup.Rmd"}
```

# Running MethylAid #
	
Sample quality control is performed using the
[**MethylAid**](http://bioconductor.org/MethylAid)
[@Iterson2014]. [**MethylAid**](http://bioconductor.org/MethylAid) is
specially designed for quality control of large sets of DNA
methylation data e.g., epigenomewide association studies
(EWAS). Extracting intensities from IDAT files can be done in batches
and/or in parallel to reduce memory load and/or overcome long
run-times. It requires two function calls in going from IDAT files to
launch the interactive web application; `summarize` and
`visualize`. For more information see [@Iterson2014].

First, prepare the targets file, similar to the one used by 
[**MethylAid**](http://bioconductor.org/minfi).

```{r sqc.generatetargets, message=FALSE, results='hide'}
library(BBMRIomics)
path450k <- file.path(RP3DATADIR, "IlluminaHumanMethylation450k")
samplesheets <- getView("methylationSamplesheet")
samplesheets$biobank_id <- gsub("-.*$", "", samplesheets$ids)
samplesheets$Basename <- with(samplesheets,
                              file.path(path450k, "raw", Sentrix_Barcode,
                                        paste(Sentrix_Barcode, Sentrix_Position, sep="_")))
targets <- subset(samplesheets, biobank_id == "LLS")
targets <- targets[!duplicated(targets$run_id),]
```

```{r sqc.targets}
targets[1:5, 1:5]
```

Next, summarize and visualize the data, see the
[MethylAid vignette](https://www.bioconductor.org/packages/release/bioc/vignettes/MethylAid/inst/doc/MethylAid.pdf)
for more details.

```{r sqc.methylaid, eval=FALSE}
library(MethylAid)
library(BiocParallel)
register(MulticoreParam(8, log=TRUE))
path450k <- file.path(RP3DATADIR, "IlluminaHumanMethylation450k/450k/LLS")
load(file.path(path450k, "MethylAid.RData"))
outliers <- visualize(MethylAid)
write.table(outliers,
            file=file.path(path450k, "outliers.txt"),
            quote=FALSE, row.names=FALSE)
```

Check the interactive visualization of the
[LLS 450k data](http://http://bios-vm.bbmrirp3-lumc.surf-hosted.nl:8008/BIOSRutils/DNAm/LLS)
generated by [**MethylAid**](http://bioconductor.org/MethylAid).

It turns out that 5 samples do not pass quality control.

# Constructing an `RGset`-object in parallel #

Reading a large number of IDAT-files can be time-consuming. The
[**DNAmArray**](https://github.com/molepi/DNAmArray) package offers
the `read.450k.exp.par`-function for reading IDAT-files in parallel
using functionallity from
[**BiocParallel**](http://bioconductor.org/BiocParallel). The
target-file is divided in a number of smaller targets files according
to the number of workers (compute nodes) available. On each worknode a
subset of IDAT-files are read using the regular
[**minfi**](http://bioconductor.org/minfi)
function-`read.450k.expr`. Once all idat-files are read they are
combined into on `RGChannelSet`-object and returned.

First, we remove those samples that did not pass quality control.

```{r ri.removeoutliers}
path450k <- file.path(RP3DATADIR, "IlluminaHumanMethylation450k/450k/LLS")
outliers <- read.table(file.path(path450k, "outliers.txt"), header=TRUE)    
targets <- targets[!(targets$ids %in% outliers$ids), ]
```

## Using multiple cores ##
	
```{r ri.readidats, results='hide', messages=FALSE}
library(BiocParallel)
library(DNAmArray)
register(MulticoreParam(8))
RGset <- read.450k.exp.par(targets, verbose=TRUE, extended=TRUE)
```

```{r ri.rgset}
RGset
```

Reading data in parallel can go wrong and often debugging is
difficult. Recently,
[**BiocParallel**](http://bioconductor.org/BiocParallel) has been
extended with a comprehensive set of functions for debugging for the
various parallel architectures. We recommend running
e.g. `MulticoreParam` with option `log=TRUE`.

## On a cluster ##
     
[**BiocParallel**](http://bioconductor.org/BiocParallel) offers
functionality to run jobs in parallel on various architectures e.g. on
a Sun Grid Enginge.

```{r cluster, eval=FALSE}
library(BiocParallel)
library(BatchJobs)
library(MethylAid)
CONF.FILE <- system.file("scripts/config.R", package="MethylAid")
register(BatchJobsParam(workers = 10, progressbar = TRUE, conffile = CONF.FILE))
RGset <- read.450k.exp.par(targets, verbose=TRUE, extended=FALSE)
```


# References #
